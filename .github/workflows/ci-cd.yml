name: CI/CD Pipeline

# When to run this pipeline
on:
  push:
    branches: [ main ]  # Runs when you push to main branch
  pull_request:
    branches: [ main ]  # Runs when someone creates a PR to main

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout your code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Java for backend
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Set up Node.js for frontend
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # ADD THIS STEP - Fix permission for Maven wrapper
      - name: Set execute permission for Maven wrapper
        run: |
          cd backEnd
          chmod +x mvnw
          cd ..

      # 4. Build backend (Spring Boot)
      - name: Build backEnd
        run: |
          cd backEnd
          ./mvnw clean package -DskipTests
        env:
          SPRING_PROFILES_ACTIVE: test

      # 5. Build frontend (React)
      - name: Build frontEnd
        run: |
          cd frontEnd
          npm install
          npm run build

      # 6. Run backend tests
      - name: Run backend tests
        run: |
          cd backEnd
          ./mvnw test

      # 7. Run frontend tests (if you have any)
      - name: Run frontend tests
        run: |
          cd frontEnd
          npm test -- --passWithNoTests

      # 8. Build Docker images
      - name: Build Docker images
        run: |
          docker build -t bus-backEnd:latest ./backend
          docker build -t bus-frontEnd:latest ./frontend